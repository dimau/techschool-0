# TechSchool Intro Project

This is an experimental project with using Go, Kafka, PostgreSQL, Redis, Flyway and other technologies

## Goal

Необходимо разработать демонстрационный сервис с простейшим интерфейсом, отображающий данные о заказе.

Данное задание предполагает создание небольшого микросервиса на Go с использованием базы данных и очереди сообщений. Сервис будет получать данные заказов из очереди (Kafka), сохранять их в базу данных (PostgreSQL) и кэшировать в памяти для быстрого доступа.

### Развернуть локально базу данных

1. Cоздать новую базу данных для сервиса
2. Настроить пользователя: заведите пользователя и выдайте права на созданную БД
3. Создать таблицы: спроектируйте структуру для хранения полученных данных о заказах, ориентируясь на прилагаемую модель данных.

### Разработать сервис

1. Написать приложение на Go, реализующее описанные ниже функции.
2. Разработать простейший интерфейс для отображения полученных данных по ID заказа.
3. Подключиться и подписаться на канал сообщений: настроить получение данных из брокера сообщений (Kafka).
4. Сохранять полученные данные в БД: при приходе нового сообщения о заказе, парсить его и вставлять соответствующую запись(и) в базу данных (PostgreSQL).
5. Реализовать кэширование данных в сервисе: хранить последние полученные данные заказов в памяти (например, в map), чтобы быстро выдавать их по запросу.
6. При перезапуске восстанавливать кеш из БД: при старте сервиса заполнять кеш актуальными данными из базы, чтобы продолжить обслуживание запросов без задержек.
7. Запустить HTTP-сервер для выдачи данных по ID: реализовать HTTP-эндпоинт, который по order_id будет возвращать данные заказа из кеша (JSON API). Если в кеше данных нет, можно подтягивать из БД.

### Разработать простой веб-интерфейс

1. Разработать страницу (HTML/JS), где можно ввести ID заказа и получить информацию о нём, обращаясь к вышеописанному HTTP API.

### Модель данных

1. Модель данных заказа (поля заказа, доставки, оплаты и товаров) прилагается в JSON-файле
2. Данные, приходящие из очереди, могут быть невалидными — необходимо предусмотреть обработку ошибок (например, игнорируйте или логируйте некорректные сообщения). В ходе реализации убедитесь, что при сбоях (ошибка базы, падение сервиса) данные не теряются — используйте транзакции, механизм подтверждения сообщений от брокера и т.д.

```json
{
   "order_uid": "b563feb7b2b84b6test",
   "track_number": "WBILMTESTTRACK",
   "entry": "WBIL",
   "delivery": {
      "name": "Test Testov",
      "phone": "+9720000000",
      "zip": "2639809",
      "city": "Kiryat Mozkin",
      "address": "Ploshad Mira 15",
      "region": "Kraiot",
      "email": "test@gmail.com"
   },
   "payment": {
      "transaction": "b563feb7b2b84b6test",
      "request_id": "",
      "currency": "USD",
      "provider": "wbpay",
      "amount": 1817,
      "payment_dt": 1637907727,
      "bank": "alpha",
      "delivery_cost": 1500,
      "goods_total": 317,
      "custom_fee": 0
   },
   "items": [
      {
         "chrt_id": 9934930,
         "track_number": "WBILMTESTTRACK",
         "price": 453,
         "rid": "ab4219087a764ae0btest",
         "name": "Mascaras",
         "sale": 30,
         "size": "0",
         "total_price": 317,
         "nm_id": 2389212,
         "brand": "Vivienne Sabo",
         "status": 202
      }
   ],
   "locale": "en",
   "internal_signature": "",
   "customer_id": "test",
   "delivery_service": "meest",
   "shardkey": "9",
   "sm_id": 99,
   "date_created": "2021-11-26T06:22:19Z",
   "oof_shard": "1"
}
```

### Тестирование

1. После реализации убедитесь, что:
2. Сервис подключается к брокеру сообщений (Kafka) и обрабатывает сообщения онлайн (можно написать скрипт-эмулятор отправки сообщений). 
3. Кеш действительно ускоряет получение данных (например, при повторных запросах по одному и тому же ID). 
4. HTTP-сервер возвращает корректные данные в формате JSON. 
5. Пример запроса: GET http://localhost:8081/order/<order_uid> должен вернуть JSON с информацией о заказе. 
6. Интерфейс отображает данные понятным образом после ввода ID и нажатия кнопки.

## Requirements

- Go 1.24+
- PostgreSQL 15+
- Flyway CLI (опционально, если используете Docker)

## Установка Flyway

### macOS (с Homebrew)

```bash
brew install flyway
```

### Linux

```bash
# Скачайте Flyway с официального сайта
wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.22.3/flyway-commandline-9.22.3-linux-x64.tar.gz | tar xvz
sudo ln -s `pwd`/flyway-9.22.3/flyway /usr/local/bin/flyway
```

### Windows

Скачайте Flyway с [официального сайта](https://flywaydb.org/download) и добавьте в PATH.

## Настройка базы данных

1. Убедитесь, что PostgreSQL запущен
2. Создайте базу данных:

```bash
createdb techschool
```

## Конфигурация

Основные настройки Flyway находятся в файле `flyway.conf`:

- **URL базы данных**: `jdbc:postgresql://localhost:5432/techschool`
- **Пользователь**: `postgres`
- **Пароль**: `postgres`
- **Папка миграций**: `migrations/`
- **Префикс миграций**: `V`
- **Разделитель**: `__`
- **Суффикс**: `.sql`

## Использование

### Основные команды

```bash
# Применить все pending миграции
make migrate

# Показать статус миграций
make migrate-info

# Очистить базу данных (удалить все таблицы)
make migrate-clean

# Восстановить историю миграций
make migrate-repair

# Валидировать миграции
make migrate-validate

# Создать новую миграцию
make migrate-create
```

### Прямые команды Flyway

```bash
# Применить миграции
flyway -configFiles=flyway.conf migrate

# Показать информацию
flyway -configFiles=flyway.conf info

# Очистить базу
flyway -configFiles=flyway.conf clean

# Восстановить
flyway -configFiles=flyway.conf repair

# Валидировать
flyway -configFiles=flyway.conf validate
```

## Создание новых миграций

### Автоматическое создание

```bash
make migrate-create
# Введите описание миграции
```

### Ручное создание

Создайте файл в папке `migrations/` с именем в формате:

```
V{версия}__{описание}.sql
```

Пример: `V2__Add_user_table.sql`

## Структура миграций

```
migrations/
├── V1__Create_orders_tables.sql    # Создание таблиц заказов
└── V2__Add_user_table.sql          # Добавление таблицы пользователей
```

## Docker

### Запуск с Docker Compose

```bash
# Запустить все сервисы (PostgreSQL + Flyway + App)
docker-compose up -d

# Просмотр логов
docker-compose logs -f

# Остановить сервисы
docker-compose down
```

### Только база данных

```bash
# Запустить только PostgreSQL
docker-compose up postgres -d

# Применить миграции
make migrate
```

## Разработка

```bash
# Установить зависимости
make deps

# Запустить в режиме разработки
make dev

# Собрать приложение
make build

# Запустить приложение
make run

# Запустить тесты
make test
```

## Полезные команды

```bash
# Показать все доступные команды
make help

# Настройка базы данных
make db-setup

# Очистка артефактов сборки
make clean
```

## Troubleshooting

### Проблемы с подключением к базе данных

1. Убедитесь, что PostgreSQL запущен
2. Проверьте настройки в `flyway.conf`
3. Убедитесь, что база данных `techschool` существует

### Проблемы с миграциями

1. Проверьте синтаксис SQL в файлах миграций
2. Убедитесь, что имена файлов соответствуют конвенции Flyway
3. Используйте `make migrate-validate` для проверки

### Очистка и перезапуск

```bash
# Очистить базу данных
make migrate-clean

# Применить миграции заново
make migrate
```

## Структура проекта

```
.
├── migrations/           # SQL миграции
│   └── V1__Create_orders_tables.sql
├── models/              # Go модели
├── workerpool/          # Worker pool
├── flyway.conf          # Конфигурация Flyway
├── docker-compose.yml   # Docker конфигурация
├── Makefile            # Команды для разработки
├── go.mod              # Go модули
└── main.go             # Главный файл приложения
```
